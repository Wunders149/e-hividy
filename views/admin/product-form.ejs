<%- include('partials/head', { title: isEdit ? 'Edit Product' : 'Add Product' }) %>
<%- include('partials/sidebar', { activePage: 'products' }) %>

<main class="admin-main">
  <div class="page-header">
    <div>
      <h1>
        <i data-lucide="<%= isEdit ? 'edit-3' : 'plus-circle' %>"></i>
        <%= isEdit ? 'Edit Product' : 'Add New Product' %>
      </h1>
      <p class="text-muted" style="margin: 0.25rem 0 0 0; font-size: 0.9375rem;">
        <%= isEdit ? 'Update product details and inventory' : 'Fill in the details to add a new product to your catalog' %>
      </p>
    </div>
    <div class="page-header-actions">
      <a href="/admin/products" class="admin-btn admin-btn-secondary">
        <i data-lucide="arrow-left"></i> Back
      </a>
    </div>
  </div>

  <!-- Product Form Card -->
  <div class="card product-form-container">
    <div class="card-body">
      <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert <%= message.toLowerCase().includes('error') || message.toLowerCase().includes('required') ? 'alert-error' : 'alert-success' %>">
          <i data-lucide="<%= message.toLowerCase().includes('error') ? 'alert-circle' : 'check-circle' %>"></i>
          <%= message %>
        </div>
      <% } %>

      <form method="POST" enctype="multipart/form-data" id="productForm" novalidate>
        <div class="form-layout">
          <!-- Main Content -->
          <div class="form-main">
            <!-- Product Name -->
            <div class="form-group">
              <label for="name">
                <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 6px; vertical-align: middle;"></i>
                Product Name <span class="required">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                class="form-control"
                value="<%= typeof product !== 'undefined' && product ? product.name : '' %>"
                placeholder="e.g., Wireless Bluetooth Headphones"
                required
                minlength="3"
              >
              <span class="form-hint">Enter a descriptive name (at least 3 characters)</span>
            </div>

            <!-- Description -->
            <div class="form-group">
              <label for="description">
                <i data-lucide="file-text" style="width: 14px; height: 14px; margin-right: 6px; vertical-align: middle;"></i>
                Description <span class="required">*</span>
              </label>
              <textarea
                id="description"
                name="description"
                class="form-control"
                placeholder="Describe your product in detail. Include features, specifications, and benefits..."
                required
                minlength="10"
                rows="5"
              ><%= typeof product !== 'undefined' && product ? product.description : '' %></textarea>
              <div class="char-counter">
                <span id="charCount"><%= typeof product !== 'undefined' && product ? product.description.length : 0 %></span> characters
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="form-sidebar">
            <!-- Pricing Card -->
            <div class="form-card">
              <h3 class="form-card-title">
                <i data-lucide="dollar-sign"></i>
                Pricing
              </h3>
              <div class="form-group">
                <label for="price">Price ($)</label>
                <div class="input-with-icon">
                  <span class="input-prefix">$</span>
                  <input
                    type="number"
                    id="price"
                    name="price"
                    class="form-control"
                    step="0.01"
                    min="0"
                    value="<%= typeof product !== 'undefined' && product ? parseFloat(product.price) : '' %>"
                    placeholder="0.00"
                    required
                  >
                </div>
                <span class="form-hint">Set the selling price</span>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label for="stock">Stock Quantity</label>
                <div class="input-with-icon">
                  <i data-lucide="package" class="input-icon-left"></i>
                  <input
                    type="number"
                    id="stock"
                    name="stock"
                    class="form-control"
                    min="0"
                    value="<%= typeof product !== 'undefined' && product ? product.stock : '' %>"
                    placeholder="0"
                    required
                  >
                </div>
                <span class="form-hint">Available inventory count</span>
              </div>
            </div>

            <!-- Image Upload Card -->
            <div class="form-card">
              <h3 class="form-card-title">
                <i data-lucide="image"></i>
                Product Image
              </h3>

              <% if (isEdit && product && product.image) { %>
                <div class="current-image-preview">
                  <img src="<%= product.image %>" alt="Current Image" id="currentImagePreview">
                  <p class="text-muted small mt-1">Current: <%= product.image.split('/').pop() %></p>
                </div>
              <% } %>

              <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('image').click()">
                <i data-lucide="upload-cloud" class="image-upload-icon"></i>
                <div class="image-upload-text">
                  <strong>Click to upload</strong> or drag and drop
                </div>
                <div class="image-upload-hint">
                  PNG, JPG, GIF up to 5MB
                </div>
                <input
                  type="file"
                  id="image"
                  name="image"
                  accept="image/*"
                  style="display: none;"
                  onchange="handleImageSelect(event)"
                >
              </div>

              <div id="imagePreview" class="form-preview hidden">
                <img id="previewImg" src="" alt="Preview">
                <p class="text-muted small mt-1" id="imageFileName"></p>
                <button type="button" class="btn-remove-image" onclick="removeImage(event)">
                  <i data-lucide="x"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Buttons -->
        <div class="form-buttons">
          <button type="submit" class="admin-btn admin-btn-lg" id="submitBtn">
            <i data-lucide="<%= isEdit ? 'save' : 'plus-circle' %>"></i>
            <%= isEdit ? 'Update Product' : 'Add Product' %>
          </button>
          <a href="/admin/products" class="admin-btn admin-btn-secondary admin-btn-lg">
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</main>

<style>
  .form-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 2rem;
  }

  .form-main {
    min-width: 0;
  }

  .form-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-card {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-xl);
    padding: 1.25rem;
  }

  .form-card-title {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-card-title i {
    color: var(--primary);
    width: 18px;
    height: 18px;
  }

  .form-hint {
    display: block;
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.375rem;
  }

  .char-counter {
    text-align: right;
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.375rem;
  }

  .input-with-icon {
    position: relative;
  }

  .input-prefix {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    font-weight: 600;
    pointer-events: none;
  }

  .input-icon-left {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
    width: 18px;
    height: 18px;
    pointer-events: none;
  }

  .input-with-icon .form-control {
    padding-left: 2.75rem;
  }

  .current-image-preview {
    margin-bottom: 1rem;
  }

  .current-image-preview img,
  .form-preview img {
    width: 100%;
    max-width: 280px;
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
    box-shadow: var(--shadow-sm);
  }

  .form-preview {
    position: relative;
    margin-top: 1rem;
  }

  .btn-remove-image {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    border: none;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-md);
    transition: var(--transition);
  }

  .btn-remove-image:hover {
    background: var(--danger-dark);
    transform: scale(1.1);
  }

  .btn-remove-image i {
    width: 16px;
    height: 16px;
  }

  .image-upload-area {
    border: 2px dashed var(--gray-300);
    border-radius: var(--radius-lg);
    padding: 1.5rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    background: var(--white);
  }

  .image-upload-area:hover,
  .image-upload-area.drag-over {
    border-color: var(--primary);
    background: var(--primary-light);
  }

  .image-upload-icon {
    width: 40px;
    height: 40px;
    color: var(--gray-400);
    margin: 0 auto 0.75rem;
    transition: var(--transition);
  }

  .image-upload-area:hover .image-upload-icon {
    color: var(--primary);
    transform: translateY(-2px);
  }

  .image-upload-text {
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.25rem;
    font-size: 0.9375rem;
  }

  .image-upload-hint {
    font-size: 0.75rem;
    color: var(--gray-500);
  }

  .form-control:invalid {
    border-color: var(--warning);
  }

  .form-control:invalid:focus {
    box-shadow: 0 0 0 4px var(--warning-light);
  }

  @media (max-width: 1024px) {
    .form-layout {
      grid-template-columns: 1fr;
    }

    .form-sidebar {
      order: -1;
    }

    .form-card {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-card > * {
      grid-column: span 2;
    }

    .form-card .form-group {
      grid-column: span 1;
    }
  }

  @media (max-width: 768px) {
    .form-card {
      grid-template-columns: 1fr;
    }

    .form-card .form-group {
      grid-column: span 1;
    }
  }
</style>

<script>
  // Character counter for description
  const descriptionTextarea = document.getElementById('description');
  const charCount = document.getElementById('charCount');

  descriptionTextarea.addEventListener('input', function() {
    charCount.textContent = this.value.length;
  });

  // Image preview handler
  function handleImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('Image size must be less than 5MB', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('imagePreview');
        const img = document.getElementById('previewImg');
        const fileName = document.getElementById('imageFileName');

        img.src = e.target.result;
        fileName.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
        preview.classList.remove('hidden');

        document.querySelector('.image-upload-text').innerHTML = '<strong>' + file.name + '</strong>';
      };
      reader.readAsDataURL(file);
    }
  }

  function removeImage(event) {
    event.stopPropagation();
    event.preventDefault();

    document.getElementById('image').value = '';
    document.getElementById('imagePreview').classList.add('hidden');
    document.querySelector('.image-upload-text').innerHTML = '<strong>Click to upload</strong> or drag and drop';
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Drag and drop for image upload
  const uploadArea = document.getElementById('imageUploadArea');

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });

  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');

    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      if (file.size > 5 * 1024 * 1024) {
        showToast('Image size must be less than 5MB', 'error');
        return;
      }
      const input = document.getElementById('image');
      input.files = e.dataTransfer.files;
      handleImageSelect({ target: { files: e.dataTransfer.files } });
    } else {
      showToast('Please drop an image file', 'error');
    }
  });

  // Form validation
  document.getElementById('productForm').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const price = document.getElementById('price').value;
    const stock = document.getElementById('stock').value;

    // Clear previous errors
    document.querySelectorAll('.form-control').forEach(el => {
      el.classList.remove('error');
    });

    let hasError = false;

    if (!name || name.length < 3) {
      e.preventDefault();
      showToast('Product name must be at least 3 characters', 'error');
      document.getElementById('name').focus();
      hasError = true;
      return false;
    }

    if (!description || description.length < 10) {
      e.preventDefault();
      showToast('Description must be at least 10 characters', 'error');
      document.getElementById('description').focus();
      hasError = true;
      return false;
    }

    if (!price || parseFloat(price) < 0) {
      e.preventDefault();
      showToast('Please enter a valid price', 'error');
      document.getElementById('price').focus();
      hasError = true;
      return false;
    }

    if (stock === '' || parseInt(stock) < 0) {
      e.preventDefault();
      showToast('Please enter a valid stock quantity', 'error');
      document.getElementById('stock').focus();
      hasError = true;
      return false;
    }

    if (!hasError) {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader" class="spin"></i> ' + (isEdit ? 'Updating...' : 'Adding...');
      lucide.createIcons();
    }
  });

  // Real-time validation feedback
  document.querySelectorAll('.form-control').forEach(input => {
    input.addEventListener('blur', function() {
      if (this.validity.valid) {
        this.style.borderColor = 'var(--success)';
      } else if (this.value !== '') {
        this.style.borderColor = 'var(--danger)';
      } else {
        this.style.borderColor = 'var(--gray-300)';
      }
    });

    input.addEventListener('focus', function() {
      this.style.borderColor = 'var(--primary)';
    });
  });
</style>

<%- include('partials/footer') %>
<%- include('partials/scripts') %>
