<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Products - E-Hividy Admin</title>
  <link rel="stylesheet" href="/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <button class="menu-toggle" onclick="toggleAdminMenu()">‚ò∞</button>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <h2>
          <span class="logo-icon">üõçÔ∏è</span>
          E-Hividy Admin
        </h2>
      </div>
      
      <nav class="admin-sidebar-nav">
        <ul>
          <li><a href="/admin/dashboard"><span class="icon">üìä</span> Dashboard</a></li>
          <li><a href="/admin/products" class="active"><span class="icon">üì¶</span> Products</a></li>
          <li><a href="/admin/orders"><span class="icon">üìã</span> Orders</a></li>
          <li><a href="#" onclick="showLogoutModal(event)"><span class="icon">üö™</span> Logout</a></li>
        </ul>
      </nav>
      
      <div class="admin-sidebar-footer">
        <div class="admin-user-info">
          <div class="admin-user-avatar">
            <%= (admin.name || admin.email || 'A')[0].toUpperCase() %>
          </div>
          <div class="admin-user-details">
            <div class="admin-user-name"><%= admin.name || 'Admin' %></div>
            <div class="admin-user-email"><%= admin.email %></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="page-header">
        <h1>üì¶ Manage Products</h1>
        <div class="page-header-actions">
          <a href="/admin/products/add" class="admin-btn">
            <span>‚ú®</span> Add New Product
          </a>
        </div>
      </div>

      <!-- Products Card -->
      <div class="card">
        <div class="card-body" style="padding: 0;">
          <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-error" style="margin: 1.5rem;">
              <span>‚ö†Ô∏è</span> <%= error %>
            </div>
          <% } %>

          <% if (products && products.length > 0) { %>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% products.forEach(product => { %>
                    <tr>
                      <td><strong>#<%= product.id %></strong></td>
                      <td>
                        <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                          <% if (product.image) { %>
                            <img src="<%= product.image %>" 
                                 alt="<%= product.name %>" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                          <% } else { %>
                            <span style="font-size: 1.5rem;">üì¶</span>
                          <% } %>
                        </div>
                      </td>
                      <td>
                        <strong style="color: var(--dark);"><%= product.name %></strong>
                      </td>
                      <td style="max-width: 250px;">
                        <span style="color: var(--gray-500); font-size: 0.9rem;">
                          <%= product.description.length > 60 ? product.description.substring(0, 60) + '...' : product.description %>
                        </span>
                      </td>
                      <td>
                        <strong class="text-success">$<%= parseFloat(product.price).toFixed(2) %></strong>
                      </td>
                      <td>
                        <% if (product.stock > 10) { %>
                          <span class="status-badge status-success">‚úì <%= product.stock %> in stock</span>
                        <% } else if (product.stock > 0) { %>
                          <span class="status-badge status-warning">‚ö† <%= product.stock %> left</span>
                        <% } else { %>
                          <span class="status-badge status-failed">‚úï Out of stock</span>
                        <% } %>
                      </td>
                      <td>
                        <div class="action-buttons">
                          <a href="/admin/products/edit/<%= product.id %>" 
                             class="btn-action btn-action-edit"
                             title="Edit Product">
                            ‚úèÔ∏è Edit
                          </a>
                          <button class="btn-action btn-action-delete" 
                                  onclick="deleteProduct('<%= product.id %>', '<%= product.name %>')"
                                  title="Delete Product">
                            üóëÔ∏è Delete
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <h3>No Products Found</h3>
              <p>Get started by adding your first product to the catalog</p>
              <a href="/admin/products/add" class="admin-btn">
                <span>‚ú®</span> Add First Product
              </a>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üóëÔ∏è Confirm Delete</h3>
        <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="deleteProductName"></strong>? This action cannot be undone and will remove all associated data.</p>
      </div>
      <div class="modal-footer">
        <button class="admin-btn admin-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="admin-btn admin-btn-danger" id="confirmDeleteBtn">
          üóëÔ∏è Yes, Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal-overlay" id="logoutModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üö™ Confirm Logout</h3>
        <button class="modal-close" onclick="closeLogoutModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to logout from the admin panel? You will need to login again to access admin features.</p>
      </div>
      <div class="modal-footer">
        <button class="admin-btn admin-btn-secondary" onclick="closeLogoutModal()">Cancel</button>
        <a href="/admin/logout" class="admin-btn admin-btn-danger">Yes, Logout</a>
      </div>
    </div>
  </div>

  <script>
    // Toggle sidebar menu
    function toggleAdminMenu() {
      const sidebar = document.getElementById('adminSidebar');
      sidebar.classList.toggle('active');
    }

    // Close menu when a link is clicked
    document.querySelectorAll('#adminSidebar a').forEach(link => {
      link.addEventListener('click', () => {
        document.getElementById('adminSidebar').classList.remove('active');
      });
    });

    // Delete product functions
    let deleteProductId = null;

    function deleteProduct(id, name) {
      deleteProductId = id;
      document.getElementById('deleteProductName').textContent = name;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      deleteProductId = null;
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
      if (deleteProductId) {
        fetch('/admin/products/delete/' + deleteProductId, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              showToast('Product deleted successfully', 'success');
              setTimeout(() => location.reload(), 1000);
            } else {
              showToast('Error deleting product: ' + (data.error || 'Unknown error'), 'error');
            }
          })
          .catch(err => {
            showToast('Error: ' + err.message, 'error');
          });
        closeDeleteModal();
      }
    });

    // Close modal on overlay click
    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });

    // Logout modal functions
    function showLogoutModal(event) {
      event.preventDefault();
      document.getElementById('logoutModal').classList.add('active');
    }

    function closeLogoutModal() {
      document.getElementById('logoutModal').classList.remove('active');
    }

    document.getElementById('logoutModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLogoutModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDeleteModal();
        closeLogoutModal();
      }
    });

    // Toast notification function
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      
      container.appendChild(toast);
      
      // Auto remove after 4 seconds
      setTimeout(() => {
        toast.classList.add('toast-hiding');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Check for URL parameters to show messages
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get('success');
    const error = urlParams.get('error');
    
    if (success) showToast(decodeURIComponent(success), 'success');
    if (error) showToast(decodeURIComponent(error), 'error');
  </script>
</body>
</html>
